{% extends 'base.html' %}
{% block title %} Dashboard {% endblock %}
{% block content %}
{% load filter_extras %}
{% load static %}
<div class="row container">
  <div class="col l7 s12">
    <h2 class="inline">Welcome back, </h2> 
    <h2 class="blue-paypal-text inline"> {{request.user.first_name}}</h2>
  </div>
  <div class="col l3 offset-l3 s12" style="line-height: 7">
    {% if product_count >= 5 and valid == False %}
    <a href="#modal1" class="btn-large waves-light waves-effect orange btn-block btn right-move">
    Upgrade Account
    </a>
    {% else %}
       <a href="{% url 'products_add_product' %}" class="btn-large waves-light waves-effect green btn-block btn right-move">
      + Add product
    </a>
    {% endif %}
 
  </div>
</div>
<div class="row container">
  <div class="col l12">
    {% if product_count == 1 %}
    <h5 class="inline">You are currently checking </h5><h5 class="blue-paypal-text inline">&nbsp {{product_count}}</h5><h5 class="inline"> &nbsp product for indexation</h5>
    <h5>You have 4 products left on your free trial.</h5>
    {% elif product_count > 1 and product_count < 5 %}
     <h5 class="inline">You are currently checking </h5><h5 class="blue-paypal-text inline">&nbsp {{product_count}}</h5><h5 class="inline"> &nbsp products for indexation</h5>
     <div></div>
    <h5 class="inline">You have</h5>
    <h5 class="blue-paypal-text inline"> &nbsp{{ 5|substract:product_count }}&nbsp </h5>
    <h5 class="inline">products left on your free trial.</h5>
    {% elif product_count >= 5 and valid == False %}
     <h5 class="inline">You are currently checking </h5><h5 class="blue-paypal-text inline">&nbsp {{product_count}}</h5><h5 class="inline"> &nbsp products for indexation</h5>
    <h5> You don't have any more left on your free trial.  <a href="#modal1" class="">
    Upgrade here </a>to a premium plan for just $5/month and receive unlimited products!</h5>
    {% elif product_count >= 5 and valid == True %}
    <h5 class="inline">You are currently checking </h5><h5 class="blue-paypal-text inline">&nbsp {{product_count}}</h5><h5 class="inline"> &nbsp products for indexation</h5>
    {% endif %}
  </div>
  </div>
<div class="row container">
  <div class="col l13">
    <input type="text" id="search-criteria" onkeyup="search()" placeholder="Search by name or ASIN">
  </div>
</div>
<div class="row container">
  {% for product in products %}
  <div id="{{product.pk}}" class="card card-hover col l3 m6 s12">
    <div class="card-image waves-effect waves-block waves-light">
      <a href="{% url 'products_overview_product' product.uuid %}">
      <img class="responsive-img"  src="{{product.primary_img}}">
      </a>
    </div>
    <div class="card-content row">
      <div class="card-title justify">
        <a href="{% url 'products_overview_product' product.uuid %}">
        <span data-product="{{product.pk}}" class="grey-text text-darken-4 searchable">{{product.product_name}}</span>  
        </a>
      </div>
      <div class="col l13 m13 s13">
        <span data-product="{{product.pk}}" class="card-subtitle center grey-text disabled-text-text searchable">Asin: {{product.asin}}</span>
      </div>
      <div class="col l13 m13 s13">
       <button class="button-card btn-flat waves-light waves-effect detail-green btn-block-limited float">{{product.indexing}} indexing</button>
      </div>
    </div>
  </div>
  {% endfor %}
  {% if products|length == 0 %}
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  {% endif %}
</div>
<!-- Modal Structure -->
<div id="modal1" class="modal">
  <div class="modal-content">
    <h4>Upgrade Your Account</h4>
    
      <div class="demo-container">
        <div class="card-wrapper"></div>

        <div class="form-container active">
            <form method="post" id="payment-form" data-settings-url="{% url 'stripe_charge' %}" data-coupon-url="{% url 'stripe_check_coupon' %}">
              {% csrf_token %}
                <div class="group">
                  <label>
                    <span>Name</span>
                    <input name="cardholder-name" class="field black-text" placeholder="Jane Doe" value="{{request.user.first_name}} {{request.user.last_name}}"/>
                  </label>
                </div>
                <div class="group">
                  <label>
                    <span>Card</span>
                    <div id="card-element" class="field"></div>
                  </label>
                </div>
                <div id="card-errors" class="error-stripe red-text" role="alert"></div>
                <div class="group">
                  <label>
                    <span>Coupon</span>
                    <input name="coupon" class="field black-text uppercase" placeholder="Coupon Code" />
                  </label>
                </div>
                <div class="input-field col s13 m13 l13">
                  {{form.plan}}
                  <label>Plan</label>
                </div>
                 <div class="group">
                  <label>
                    <h5 id="showTotal" class="black-text hidden">Total: </h5>
                  </label>
                </div>
            
        </div>
    </div>
  </div>
  <div class="modal-footer">
    <button id="submitbutton" type="submit" class="waves-effect waves-green btn-flat green center" style="width: 100%">Subscribe</button>
    <div id="loader" class="row hidden">
      <div class="col center offset-l6">
         <div class="preloader-wrapper active">
          <div class="spinner-layer spinner-orange-only">
            <div class="circle-clipper left">
              <div class="circle"></div>
            </div><div class="gap-patch">
              <div class="circle"></div>
            </div><div class="circle-clipper right">
              <div class="circle"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
   
  </form>
  </div>
</div>
{% endblock %}
{% block js %}
<script src="{% static 'js/search.js' %}"> </script>
<script src="https://js.stripe.com/v3/"></script>
<script>
  // Create a Stripe client
var stripe = Stripe('{{key}}');

// Create an instance of Elements
var elements = stripe.elements();

// Custom styling can be passed to options when creating an Element.
var style = {
  base: {
    color: '#32325d',
    lineHeight: '24px',
    fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
    fontSmoothing: 'antialiased',
    fontSize: '16px',
    '::placeholder': {
      color: '#aab7c4'
    }
  },
  invalid: {
    color: '#fa755a',
    iconColor: '#fa755a'
  }
};

// Create an instance of the card Element
var card = elements.create('card', {style: style});

// Add an instance of the card Element into the `card-element` <div>
card.mount('#card-element');

// Handle real-time validation errors from the card Element.
card.addEventListener('change', function(event) {
  var displayError = document.getElementById('card-errors');
  if (event.error) {
    displayError.textContent = event.error.message;
    $('#submitbutton').addClass('disabled');
  } else {
    displayError.textContent = '';
    $('#submitbutton').removeClass('disabled');
  }
});

// Handle form submission
var form = document.getElementById('payment-form');
form.addEventListener('submit', function(event) {
  event.preventDefault();
  $('#loader').show();
  $('#submitbutton').hide();
  var extraDetails = {
    name: form.querySelector('input[name=cardholder-name]').value,
  };
  stripe.createToken(card, extraDetails).then(function(result) {
    if (result.error) {
      // Inform the user if there was an error
      var errorElement = document.getElementById('card-errors');
      errorElement.textContent = result.error.message;
      $('#loader').hide();
      $('#submitbutton').show();
    
    } else {
      // Send the token to your server
      formpay = $('#payment-form');
      $.ajax({
        url: formpay.attr("data-settings-url"),
        type : "POST",
        data: formpay.serialize() + '&token='+ JSON.stringify(result.token),
        dataType: 'json',
        success: function (data) {
          if (data.valid === true) {
            Materialize.toast('Payment Accepted', 3000);
            $('#loader').hide();
            $('#submitbutton').show();
            $('#modal1').modal('close');
            Materialize.toast('Upgrading Account', 3000);
            location.reload();
          }
          else {
            var errorElement = document.getElementById('card-errors');
            errorElement.textContent = data.message;
            $('#loader').hide();
            $('#submitbutton').show();
          }
        },
        error: function(request, status, error) {
          Materialize.toast('Server error', 3000);
          $('#loader').hide();
          $('#submitbutton').show();
        }
      });
    }
  });
});

</script>
<script>
 $(document).ready(function(){
    $('.modal').modal();
    $('select').material_select();
    $('input[name=coupon]').change(function(event) {
      console.log('change')
      $('#loader').show();
      $('#submitbutton').hide();
      formpay = $('#payment-form');
       $.ajax({
        url: formpay.attr("data-coupon-url"),
        type : "POST",
        data: formpay.serialize(),
        dataType: 'json',
        success: function (data) {
          if (data.valid_coupon === true) {
            $('#showTotal').text('Total: ' + data.total_amount + ' with discount applied');
            $('#showTotal').show();
            $('#loader').hide();
            $('#submitbutton').show();
          }
          else {
            $('#loader').hide();
            $('#submitbutton').show();
          }
        },
        error: function(request, status, error) {
          Materialize.toast('Server error', 3000);
          console.log(error);
        }
      });


    });
  });
</script>
{% endblock %}
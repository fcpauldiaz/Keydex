{% extends 'base.html' %}
{% load filter_extras %}
{% block title %} Step 2 {% endblock %}
{% block content %}
<div class="row container">
  <div class="col l6 offset-l4 s13 m8 offset-m2">
    <div class="card-content">
      <ul class="stepper horizontal" id="horizontal">
         <li class="step">
            <!--data-step-label="To step-title!" -->
            <div class="step-title number-wrap waves-dark"><span class="hide-on-small-only">Step 1</span></div>
         </li>
         <li class="step active">
            <div class="step-title number-wrap waves-dark"><span class="hide-on-small-only">Step 2</span></div>
         </li>
         <li class="step">
            <div class="step-title number-wrap waves-dark"><span class="hide-on-small-only">Step 3</span></div>
         </li>
      </ul>
    </div>
  </div>
</div>
<div class="row container">
  <div class="col s12 l3 m4 offset-s2 offset-l1 offset-m3">
      <div class="card-image">
        <img class="responsive-img" src="{{ product.primary_img}}" style="margin-top: 10px;">
      </div>
  </div>
  <div class="col s12 l8 justify">
    <h3 class="main-grey-text light">
      {{product.title | title}}
    </h3>
    <h7 class="disabled-text-text">
      ASIN: {{ product.asin }}
    </h7>
  </div>
</div>
<div class="row container">
  <div class="col center s13 l5 offset-l4 offset-m4">
    <h5 class="left">Enter keywords or phrases</h5>
  </div>
   <form id="form" data-keywords-url="{% url 'products_add_keywords' marketplace.country_code product.asin %}" method="post">
    <div class="row">
      <div class="input-field col l9 s13 m13">
        <textarea id="textarea" placeholder="Copy paste here your keywords
One keyword per line
        " style="height: 125px;"></textarea>
         <button class="btn waves-effect waves-light blue-paypal btn-block" type="submit" name="action">Add these keywords
        </button>
      </div>
      <div class="input-field col s13 l4">
        <select id="select_type">
          <option value="" disabled>Choose your option</option>
          <option value="keyword" selected>Keyword</option>
          <option value="phrase">Phrase</option>
        </select>
        <label>Type</label>
      </div>
    </div>
    <div class="row">
      <div class="col l13 s13 m13">
        <table  class="bordered striped highlight">
          <thead class="detail-blue white-text">
            <tr>
              <th>Keyword</th>
              <th>Type</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="table">
          </tbody>
        </table>
        
      </div>
    </div>
    <div class="row container">
      <div class="col s12 l6 m6">
            <button id="finish" class="btn waves-effect waves-light blue-paypal btn-block" type="submit" name="action">Save and finish
        </button>
      </div>
    </div>
  </form>
</div>

{% endblock %}
{% load static %}
{% block css %}
<link href="{% static 'css/materialize-stepper.min.css' %}" rel="stylesheet" type="text/css" />
{% endblock %}
{% block js %}
<script src="{% static 'js/asins.js' %}"></script>
<script>
  var data = [];
  $('#textarea').keyup(function(event) {
    var type = $('#select_type').find(":selected").val();
    if (event.keyCode === 32 && type === 'keyword') {
      var txt = $('#textarea')
      txt.val(txt.val() + "\n");
    }

  });
  $('form').on('submit', function(event) {
    event.preventDefault();
    var lines = this.textarea.value.split('\n');
    var type = $('select').find(":selected").text();
    if (lines.length === 0 && this.textarea.value !== '') {
      var row = table.insertRow(-1);
      var cell1 = row.insertCell(0);
      var cell2 = row.insertCell(1);
      var cell3 = row .insertCell(2);
      cell1.innerHTML = this.textarea.value.trim().replace(/[^\x00-\x7F]/g, "");;
      cell2.innerHTML = type;
      cell3.innerHTML = "<td><i class='small material-icons'>close</i></td>";
    }
    var table = document.getElementById('table');
    for(var i = 0; i < lines.length; i++) {
      var text = lines[i].trim().replace(/[^\x00-\x7F]/g, "");;
      if (text === '' || data.includes(text)) {
        continue;
      }
      
      var row = table.insertRow(-1);
      var cell1 = row.insertCell(0);
      var cell2 = row.insertCell(1);
      var cell3 = row .insertCell(2);
      cell1.innerHTML = lines[i];
      cell2.innerHTML = type;
      cell3.innerHTML = "<td><i class='small material-icons'>close</i></td>";
      data.push(text);
    }
    this.textarea.value = '';
  });
  $(document).on('click', '.material-icons', function(event) {
    var p = $(this).closest('tr');
    var tds = p[0].getElementsByTagName('td');
    var index = data.indexOf(tds[0].innerHTML.trim());
    if (index > -1) {
      data.splice(index, 1);
    }
    var deleteRow = $(this).closest('tr').index()
    var table = document.getElementById('table');
    var row = table.deleteRow(deleteRow);
  });
  $('select').on('change', function() {
    var txt = $('#textarea')
    txt.val('');
    var type = $('#select_type').find(':selected').val();
    if (type === 'phrase') {
      txt.prop('placeholder', "Copy paste here your phrases \nOne phrase per line");
    } else {
      txt.prop('placeholder', 'Copy paste here your keywords \nOne keyword per line');
    }
  });
  $('#textarea').bind('paste', function() {
    setTimeout(function() {
      var type = $('#select_type').find(':selected').val();
      if (type === 'keyword') {
        var txt = $('#textarea');
        var splitted = txt.val().split(' ');
        for (i = 0; i < splitted.length; i++) {
          if (i === 0) {
            txt.val(splitted[i].toLowerCase().replace(/[^\x00-\x7F]/g, " ") + "\n");
          } else {
            txt.val(txt.val() + splitted[i].toLowerCase().replace(/[^\x00-\x7F]/g, " ") + "\n");
          }
        }
      }
    }, 20);
  });
</script>
<script>
  //For getting CSRF token
function getCookie(name) {
  var cookieValue = null;
  if (document.cookie && document.cookie != '') {
    var cookies = document.cookie.split(';');
    for (var i = 0; i < cookies.length; i++) {
         var cookie = jQuery.trim(cookies[i]);
    // Does this cookie string begin with the name we want?
    if (cookie.substring(0, name.length + 1) == (name + '=')) {
      cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
       }
      }
    }
  return cookieValue;
}
</script>
<script>
  $("#finish").on("click", function (e) {  
    e.preventDefault();
    $('#chip-button').hide();
    $('#loader').show();
    table = document.getElementById('table');
    var keywords = [];
    var phrases = [];
    for (var i = 0; i < table.rows.length; i++) {
      var tds = table.rows[i].getElementsByTagName('td');

      if (tds[1].innerText === 'Keyword' && !keywords.includes(tds[1].innerText)) {
        keywords.push(tds[0].innerText);
      }
      else if (tds[1].innerText === 'Phrase' && !phrases.inclues(tds[1].innerText)) {
        phrases.push(tds[0].innerText);
      }
    }
    var form = $('form');
    $.ajax({
      url: form.attr("data-keywords-url"),
      type : "POST",
      data: { 
        csrfmiddlewaretoken : getCookie('csrftoken'), 
        chips_keywords: JSON.stringify(keywords),
        chips_phrases: JSON.stringify(phrases) 
      },
      dataType: 'json',
      success: function (data) {
        var data_key = JSON.parse(data.data_key);
        var data_phrase = JSON.parse(data.data_phrase)
        if (data_key.length === 0 && data_phrase.length === 0) {
          Materialize.toast('Please add some keywords', 3000);
          $('#chip-button').show();
          $('#loader').hide();
        }
        else {
          window.location.href = '/product/save/';
        }
      },
      error: function(request, status, error) {
        console.log(error);
      }
    });

  });
</script>
{% endblock js %}
